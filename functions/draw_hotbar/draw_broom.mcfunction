tag @s[scores={broomDelay=-1},tag=broomDelay] remove broomDelay
tag @s[scores={broomDelay=1..}] add broomDelay
tag @s[scores={broomDelay=0}] remove broomDelay

# Check if player is not riding the broom anymore
execute as @s[tag=flyingBroom,nbt=!{RootVehicle:{Entity:{id:"minecraft:armor_stand"}}}] run tag @s add notRidingBroom


# Speed indicator in offhand
replaceitem entity @s[scores={broomSpeed=0},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:12}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:12,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=1},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:11}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:11,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=2},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:10}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:10,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=3},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:9}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:9,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=4},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:8}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:8,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=5},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:7}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:7,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=6},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:6}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:6,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=7},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:5}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:5,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=8},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:4}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:4,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=9},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:3}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:3,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=10},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:2}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:2,fDetect:1b}
replaceitem entity @s[scores={broomSpeed=11},nbt=!{Inventory:[{Slot:-106b,id:"minecraft:golden_sword",tag:{Damage:1}}]}] weapon.offhand minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:1,fDetect:1b}



# Speed overlay - Done with multiple models because minecraft doesn't support block / item animation or whatever it's called with textures that large.
# player velocity is sqrt(velX^2+velY^2+velZ^2) (pythagoras) can't do squareroot in minecraft easily so I just check for the speed squared

scoreboard players set @s velocity 0
scoreboard players operation @s tmp = @s movX
scoreboard players operation @s tmp *= @s movX
scoreboard players operation @s velocity += @s tmp
scoreboard players operation @s tmp = @s movY
scoreboard players operation @s tmp *= @s movY
scoreboard players operation @s velocity += @s tmp
scoreboard players operation @s tmp = @s movZ
scoreboard players operation @s tmp *= @s movZ
scoreboard players operation @s velocity += @s tmp


# Sound also uses this velocity calculation which is why it's placed here:
execute as @s[tag=!notRidingBroom,tag=!playingBroomWindSound,scores={velocity=13333..,broomDelay=0}] run scoreboard players set @s broomWindSound 28500
execute as @s[tag=!notRidingBroom,tag=!playingBroomWindSound,scores={velocity=13333..,broomDelay=0}] run playsound minecraft:custom.ambient.hogwarts.hogwarts_grounds_high hostile @s ~ ~ ~ 1000000 1.5 1
execute as @s[tag=!notRidingBroom,tag=!playingBroomWindSound,scores={velocity=13333..,broomDelay=0}] run tag @s add playingBroomWindSound
execute as @s[tag=!notRidingBroom,tag=playingBroomWindSound,scores={velocity=..10000,broomDelay=0}] run stopsound @s hostile minecraft:custom.ambient.hogwarts.hogwarts_grounds_high
execute as @s[tag=!notRidingBroom,tag=playingBroomWindSound,scores={velocity=..10000,broomDelay=0}] run playsound minecraft:custom.ambient.hogwarts.hogwarts_grounds_high_fade hostile @s ~ ~ ~ 1000000 1.5 1
execute as @s[tag=!notRidingBroom,tag=playingBroomWindSound,scores={velocity=..10000,broomDelay=0}] run tag @s remove playingBroomWindSound

# Repeat sound when it's over
execute as @s[tag=playingBroomWindSound] run scoreboard players operation @s broomWindSound -= systick time
execute as @s[tag=playingBroomWindSound,scores={broomWindSound=..0}] run playsound minecraft:custom.ambient.hogwarts.hogwarts_grounds_high hostile @s ~ ~ ~ 1000000 1.5 1
execute as @s[tag=playingBroomWindSound,scores={broomWindSound=..0}] run scoreboard players set @s broomWindSound 28500


# Nothing
replaceitem entity @s[scores={velocity=0..29999}] hotbar.0 minecraft:golden_hoe{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:32}
replaceitem entity @s[scores={velocity=0..29999}] hotbar.1 minecraft:golden_hoe{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:32}
replaceitem entity @s[scores={velocity=0..29999}] hotbar.2 minecraft:golden_hoe{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:32}
replaceitem entity @s[scores={velocity=0..29999}] hotbar.3 minecraft:golden_hoe{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:32}
replaceitem entity @s[scores={velocity=0..29999}] hotbar.4 minecraft:golden_hoe{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:32}
replaceitem entity @s[scores={velocity=0..29999}] hotbar.5 minecraft:golden_hoe{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:32}
replaceitem entity @s[scores={velocity=0..29999}] hotbar.6 minecraft:golden_hoe{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:32}
replaceitem entity @s[scores={velocity=0..29999}] hotbar.7 minecraft:golden_hoe{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:32}
replaceitem entity @s[scores={velocity=0..29999}] hotbar.8 minecraft:golden_hoe{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:32}

# Fastest
replaceitem entity @s[scores={velocity=65000..,broomDelay=0}] hotbar.0 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:13}
replaceitem entity @s[scores={velocity=65000..,broomDelay=0}] hotbar.1 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:13}
replaceitem entity @s[scores={velocity=65000..,broomDelay=0}] hotbar.2 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:13}
replaceitem entity @s[scores={velocity=65000..,broomDelay=0}] hotbar.3 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:13}
replaceitem entity @s[scores={velocity=65000..,broomDelay=0}] hotbar.4 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:13}
replaceitem entity @s[scores={velocity=65000..,broomDelay=0}] hotbar.5 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:13}
replaceitem entity @s[scores={velocity=65000..,broomDelay=0}] hotbar.6 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:13}
replaceitem entity @s[scores={velocity=65000..,broomDelay=0}] hotbar.7 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:13}
replaceitem entity @s[scores={velocity=65000..,broomDelay=0}] hotbar.8 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:13}

# Medium
replaceitem entity @s[scores={velocity=30000..64999,broomDelay=0}] hotbar.0 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:14}
replaceitem entity @s[scores={velocity=30000..64999,broomDelay=0}] hotbar.1 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:14}
replaceitem entity @s[scores={velocity=30000..64999,broomDelay=0}] hotbar.2 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:14}
replaceitem entity @s[scores={velocity=30000..64999,broomDelay=0}] hotbar.3 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:14}
replaceitem entity @s[scores={velocity=30000..64999,broomDelay=0}] hotbar.4 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:14}
replaceitem entity @s[scores={velocity=30000..64999,broomDelay=0}] hotbar.5 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:14}
replaceitem entity @s[scores={velocity=30000..64999,broomDelay=0}] hotbar.6 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:14}
replaceitem entity @s[scores={velocity=30000..64999,broomDelay=0}] hotbar.7 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:14}
replaceitem entity @s[scores={velocity=30000..64999,broomDelay=0}] hotbar.8 minecraft:golden_sword{display:{Name:"{\"text\":\" \",\"color\":\"gold\",\"bold\":true}"},HideFlags:63,qDetect:1b,AttributeModifiers:[{AttributeName:"generic.attackSpeed",Name:"generic.attackSpeed",Amount:-99999,Operation:0,UUIDLeast:277390,UUIDMost:248617}],Unbreakable:1b,Damage:14}
scoreboard players remove @s[scores={broomDelay=1..}] broomDelay 1

tag @s remove notRidingBroom